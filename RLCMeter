RLCMeter

Измеряем напряжение на элементе и ток на сопротивлении которое последовательно с ним стоит.

R = 1/(2*PI*F*C)
R = (2*PI*F*L)

import math
def RFC(F,C): return 1/(2*math.pi*F*C)
def RFL(F,L): return 2*math.pi*F*L

F = 50 kHz
C = 1 mkF R = 3 Om
C = 1 nF R = 3 KOm
C = 1 pF R = 3 MOm

L = 1 mH R = 3 Om
L = 1 mkH R = 0.3 Om
L = 1 nH R = 0.3 mOm

F = 100 Hz
C = 1000 mkF R = 1.6 Om
C = 100 mkF R = 16 Om

L = 1 KH R = 628 KOm
L = 1 H R = 628 Om
L = 1 mH R = 0.6 Om

Теперь прикинем напряжение, какое можем измерять.
3.3 V напряжение измеряемое ADC
Максимальный коэффициэнт усиления 32
0.1 V при максимальном коэффициэнте
10 mA максимальный ток

100 Om == 0.1 V

Значит предусилитель x10 обязательно нужен.

Возможно лучше таки сделать "инструментальный" вариант, где резисторы переключаются с использованием реле.
74HC4052 c 100 ом проходного сопротивления - это всетаки несколько экстремально.
Это конечно несколько экстенсивно, зато позволит достаточно точно контролировать емкость параллельную сопротивлению.

Перед выходным усилителем таки сделать гальваническую развязку, это позволит избавиться от цепи подгонки постоянной составляющей напряжения.
Гальваническая развязка это не очень хорошо, потому как если будем измерять большое сопротивление, то постоянная составляющая долго может устаканиваться.

По выводам
74HC4052 == 4052
AD8532 == LM358

----------------------------
Пусть резисторы переключаются посредством 74HC4052, это экономично и мало места займет.
Пусть вход инструментального усилителя переключается посредством реле. Возьмем реле с двумя группами контактов.

Питать будем пока от USB, а в дальнейшем от батареек 6 V.
AD8532 - используем как обычные ОУ
AD8221 - инструментальный усилитель, пускай всегда усиливает в 1 и 20 раз.
MCP6S21 - усилитель с программируемым коэффициэнтом усиления 1..32 раза.

300 mV напряжение на выходе усилителей.

---------------------------
- нарисовать схему где есть два инструментальных усилителя для измерения тока и напряжения
- поставить дырки, чтобы подцепляться осциллографом

----------------------------
Перерисовал схему.

--------------

Воспользовался OP07C в качестве усилителя с низким Input Offset Voltage. В буфере/фильтре на выходе генератора частоты. И в "виртуальной земле" на 2.5 V.

Фильтр, который фильтрует DAC оставил того-же третьего порядка. Вроде должно хватать. Если учесть что будем на частоте 1 MHz сигнал генерировать, то там более чем достаточное подавление получается.

Инструментальные усилители все время работают с Ку=10 примерно. Все равно надо усиливать сигнал с 300 мВ до 3 В. Надеемся, что не будет между двумя ADC проникновения сигнала взаимного.

В генераторе тока применил AD825R микросхемку (она не работает от 5 V однополярного)


----------
- Убрать развязку по постоянному току между AD8221 и MCP6S21
- Сделать удобную функцию для запуска DAC с синусом разной частоты. --ok
	Когда минуса нет, то на выход DMA транслируется средняя амплитуда
	F = Fcpu/prescaler/BufferSize
	prescaler min = 30

- проверить, что ровно 600 кгц частоты --ok
	 	1000 samples = 119960
	 	2000 samples = 239949
	 	3000 samples = 359953
	 	получается 120 тактов на сэмпл при частоте 72 мгц
	 	20 тактов чатоты 12 мгц то есть соответствует расчетному 7.5+12.5 clock

- научиться запускать ADC одновременно с DAC --ok

- устанавливать правильную частоту дискретизации для ADC
	- максимальную частоту дискретизации по таймеру нереально установить, лучше прямо запускать
	 	6 сэмплов на 100 кгц
	 	60 сэмплов на 10 кгц
	 	600 сэмплов на 1 кгц
	 	На более низких частотах надо снижать частоту сэмплирования и увеличивать adc sampling time
	 		28.5+12.5 clock = 3.4 us time on 12 mhz
	 	например если будем считать нижней частотой 100 герц, что 100 кгц достаточно

- Сделать функцию для ADC DMA Dual Mode 

- теоретически решить вопрос, достаточно ли 6 точек -- достаточно!!!!
- посмотреть, на сколько получается сдвиг в зависимовти от того, сколько кругов прошло --сдвиг не меняется
- определить частоты на которых можно посчитать фазу/амплитуду
  adc_cycles/FCPU*N - количество секунд, для разрешенной частоты, начинаем с N=6 = 100 кгц
  F = FCPU/(adc_cycles*N)

- переделать установку частоты на такты процессора. --ok
- сделать, чтобы ADC корректно инициализировалось и при частотах ниже 600 герц
- снять данные на разных частотах
	- определить частоты --ok
	- нестабильно запускается ADC
		- попробовать запустить конверсию ADC и когда она закончится, запустить таймер DAC и запретить прерывание --не помогает
		- попробовать откалибровать ADC по выходу DAC и потов вычитать эту цифру

- прикрутить DUAL ADC и считывать/обработать данные с него --ok
- заняться таки железом --ok
	- сделать простешие щупы --ok
	- проверить, что текущая схемка работает
		схема работает, но из-за того что F107 у нас без фильтрации аналогового питания, получилось плохо
		так-же не учли, что REF пины усилителей кушают достаточно прилично

- добавить в Eagle символ STM32F303 для 100 ногого корпуса.
AD8603 имеет такие-же выводы как AD8605

- стандартный ряд сопротивлений
	1 1.2 1.5 1.8 2 2.2 2.4 2.7
	3 3.3 3.9 4.7 5.1 5.6 6.8 7.5 8.2 9.1 
-
	2.5 V, 1.5 V

	(R2+R3)/(R1+R2+R3) = 2.5/5
	(R3)/(R1+R2+R3) = 1.5/5

	R1 = 2.5
	R2 = 1
	R3 = 1.5

	R1 = 100 К
	R2 = 39 K
	R3 = 68 K
	U1 = 2.58 V
	U2 = 1.64 V

- переделать виртуальную землю на 2 LM258, а вход IC3 подключить напрямую к резисторам на 2.5 V ??????
	Проблемм с Voltage Offset быть не должно, так как LM258 усиливает в миллион раз по постоянному току.

	x/(100+x)=1.6/5
	5*x=160+1.6*x
	(5-1.6)*x=160

--------------------------------------------
Переходим на STM32F303
- скомпилировать минимальный проект --ok
- проверить FPU --ok
- прикрутить на новую USB библиотеку --ok
- запустить ADC/DAC --ok
- настроить ADC34, так как у нас для них платка сделана --ok

----------------
- разобраться с установкой резисторов --ok

----------------

- допаяли платку, получили 6 LSB ошибки. 
	Очень важно оказалось разводить аналоговую землю вблизи микроконтроллера,
	через нее шумы проникают очень сильно. Сократили длинну аналогового пина, 
	получилось уменьшить с 9 до 6 LSB ошибку. 

- управление MCP6S21 --ok

- записывать изначальные данные в json формате --ok
- стандартные графики T-I, T-V, I-V -ok
- "очищенный" график синусоиды с многократным усреднением --ok
- шум, который остался после очистки
- график задержки фазы по току/напряжению в зависимости от частоты

- open/short/load калибровку какую нить прикрутить
	open/short делаем на всех диапазонах сопротивлений
	когда щупы разомкнуты, смотрим максимум по напряжению на усилении 1x и минимум по току на усилении 32x
		не забываем что про то что есть определенная емкость и проникновение сигнала между каналами 
	когда щупы замкнуты смотрим минимум по напряжению на 32x усилении и максимум по току

	калибруем несколькими известными сопротивлениями
		например диапазон 100 ом можно откалибровать сопротивлениями примерно 1, 10, 100 ом

Ky операционного усилителя при 18 К = 3.74

- Автоматический выбор коэффициэнта усиления. --ok
- подсчет таки комплексного сопротивления --ok
	- амплитуда сигнала 
		для частот 100 - 10000 Гц 310 мВ
		для частоты 100 КГц 223 мВ 

- обработка данных на стороне микроконтроллера
	- усреднять данные "на лету" --ok
	- детектировать случай, когда "не успеваем" --ok
	- свертка с sin, cos --ok
		во float считать не успеваем, попробовать считать в int64_t --fail
		так как не успеваем считать, то просто копируем быстро данные в другой буфер, как успеем, так и посчитаем в double
		после расчетов, просим новый буфер.

- переделать протокол таким образом --ok
	- запуск DAC/ADC не означает, что данные надодятся в copy буфере --ok
	- требуем чтобы началось копирование в буфер отдельной командой --ok

- сделать чтобы DAC выбирал частоты, чтобы nsample было кратно 4 --ok
- переписать скрипт так, чтобы частота выставлялась отдельно. --ok
- автоматически выбирать резистор и диапазон усиления --ok
- пробегаться по всему диапазону, читать только LAST_COMPUTE данные
	- читать только LAST_COMPUTE в setGainAuto


- вынести вычислительную часть в отдельный файл, а то adc.c уже длинноват. --ok
- добавить вычисление среднеквадратической ошибки --ok
- разобраться почему на некоторых частотах на 100 uH растет ошибка --ok
- перепаять конденсатор, чтобы 375 КГц не ослаблялось особо. --ok
	C2 100 p -> 33 p
- перепаять резисторы, чтобы "земляное" напряжение на MCP6S21 стало --ok
	R30 100 K -> 56 K


- постоянно считать, что получилось. Усреднять данные за секунду.
- поправить usb_desc.c, чтобы там не было Stm Microelectronics

- Open/Short/Load калибровка
	есть куча неиспользуемых вариантов комбинаций коэффициэнтов усиления
	пока поступим так - оттестируем на тех вариантах, что автоматом выбираются, 
	а если выберится неожиданных коэффициэнт - то возмем с соседнего цифры.

	Все измерения производятся для каждой частоты отдельно
		- измерение замкнутых щупов для R=100 Ом
		- измерение разомкнутых щупов для R=100 КОм
		- измерение известных резисторов 1 Ом, 10 Ом, 100 Ом, 1 КОм, 10 КОм, 100 КОм

		- для эмуляции Open/Short поступаем так 
			скажем есть диапазон 1 КОм
			Калибруем его на 100 Ом, 1 КОм, 10 КОм

		- для упрощения пока считаем, что коэффициэнты усиления абсолютно правильные

		- проведем Open/Short/Load калибровку на диапазоне 100 Ом
			Будем калибровать первым попавшимся резистором в диапазоне 10-100 Ом
			Измерить Zstdm - измеренное сопротивление резистора без корректировки
			Измерить Zsm - измеренное при замкнутых щупах
			Измерить Zom - измеренное при разомкнутых щупах

- пускай будем измерять на краях диапазона.
	не забываем прибавить к 1 MOm резистору емкость щупов!

	R = 9.94 MOm
	2.656 MOm
	R0 = 1.014 MОm  1.013 MOm
	R01 = 3.674 MOm 3.671 MOm
	R012 = 4.656 MOm 4.655 MOm

	Для высоких аопротивлений необходима схема замещения с параллельным конденсатором/сопротивлением.


	Z1 = (A*Z2+B)/(C*Z2+D)
	Z1*(C*Z2+D) = A*Z2+B
	Z1*C*Z2+D*Z1 -A*Z2 - B = 0
	Z2*(Z1*C-A) = B-D*Z1
	Z2 = (-D*Z1-B)/(Z1*C-A)

	1/(1/R+W*C*j)

- калибруем относительное усиление
	калибруем на частоте 1000 Гц
	примем усиление по току с нулевым индексом за 1

	R = 200 Om
		K = 0 Rm = 197.94
		K = 1 Rm = 198.04

	R = 1000 Om
		K = 1 Rm = 987.57
		K = 2 Rm = 987.43
		K = 3 Rm = 989.75

	R = 2200 Om
		K = 3 Rm = 2187.48
		K = 4 Rm = 2189.64 
		K = 5 Rm = 2186.88 

	R = 10 KOm
		K = 5 Rm = 9857.5
		K = 6 Rm = 9881.9
		K = 7 Rm = 9886.8

	относительное усиление бесполезно калибровать, слишком мала ошибка.

- около частоты 2870 на резиторе 10 КОМ странный скачек
	period 25632
	period 24000
	в этот момент происходит переход от 1 MHz к 3 МГц DAC
	Попробуем сделать этот переход мягче

- измеряем коррекцию коэффициэнтов усиления
	измеряем на 1000 Гц, ибо на частоте 100 Гц есть небольшое ослабление из-за конденсаторов
	K0 = 197.9/200
	K1 = 992.2/1e3
	K2 = 9957.6/10e3
	K3 = 99719/100e3

- измерить таки коэффициэнты усиления на всех частотах и посмотреть что с этим сделать можно
	на частотах 100 Гц - 1000 Гц точно нужна корректировка коэффициэнта, ибо завал небольшой наблюдается. 
	Хотя из-за того что завал в двух каналах - он както компенсируется.

- проблемма при измерении емкости 910 pF на диапазоне 100-200 Гц
	решили проблемму увеличив в фильтре после ADC конденсатор.

	Надо таки поставить для низких чатот дополнительный фильтр. А для высоких частот сузить полосу фильтрации с 400 КГц до 200 КГц.

- переделать pcd8544 драйвер под 16 битные команды. Чтобы передавать команды через тот-же SPI, что и для MCP6S21 --ok

- новые печатные платы и изменение схемотехники
	- аналоговая часть
		- увеличить конденсаторы в фильтре перед IC1 чтобы был срез на 200 КГц
		- добавить включающийся конденсатор 3.3nF, чтобы для низких частотах был синус круглый --ok
		- перенести коннекторы, чтобы они были меньшим количеством плашек.
		- добавить дырку для заземления на корпус
		- расположить более компактно детальки под размер 53x50 мм, не забыть про дырки для батарей
		- по краям оставить место для винтов стягивающих
	- цифровая часть
		- 39.2 mm примерное расстояние между двумя панельками для выводов у LCD Nokia 5110 --ok
		- разместить коннекторы для дисплея на одной стороне --ok
		- разместить коннекторы для аналоговой части на другой стороне --ok
		- добавить переключатель питания батарея/USB --ok
		- объединить X3, X5  --ok
		- перевести таки R4 на какой нибудь из пинов, чтобы USB корректно инициализировалось после перепрошивки. --ok
		- добавить пины для энкодера --ok
			возможно PA6, PA7 TIM3
			PA5 - кнопка
		- переделать высоту под 49 мм, чтобы можно было разрезать кусок 10 см на два нормально пилился --ok
		- по краям оставить место для винтов, которыми будет крепиться к корпусу и винтов стягивающих две платы. --ok
		- объединить GND и GNDA --ok
		- добавить сопротивления для измерения напряжения батареи --ok
			PC5 (34) - ADC2_IN11

	
	- X=51.435 Y=26.035  - положение восточного коннектора --ok
	   SCK
	   MOSI
	   CS_V
	   CS_I
	   V_ADC
	   I_ADC


	- перенести конденсаторы которые должны стоять около ADC поближе к выходам ADC, теоретически это уменьшит уровень шума --ok
	- сделать mirror всем коннекторам на цифровой части,
		 которые идут к аналоговой части,
		 подвести к ним провода по bottom дорожкам

		 - южный --ok
		 - восточный --ok
		 - северный X=22.86 Y=46.0375 --ok

	- добавить RC цепочку между первым и вторым усилительным каскадом, чтобы отсечь выше 200 КГц --ok
	- не забыть второй коннектора для LCD Nokia 5110, который ни к чему не подключен --ok
		X = 37.465 Y=4.445+39.2

- энкодер запрограмировать --ok
	на демоплате такая разводка
	красный - GND
	белый - PC8 - кнопка
	черный - PA8 (67) - энкодер TIM1_CH1
	отдельный черный  - PA9 (68) TIM1_CH2
	зеленый - PA10 - светодиод
	синий - никуда не подключен

- проверить что правильно повернут коннектор, от которого идет синусоидальный сигнал и 3.3 nF переключатель конденсатора --ok
	не правтильно были земля и питание.

- спаяли новые платы
	- PC6 USB_ON подключить --ok
	- проверить, что какието данные идут с аналоговой части --ok
	- PB10 AN_SW подключить --ok
	- подключить дисплей --ok
		- текущая частота --ok
		- статус подключения USB
	
- убрать из platform config ненужные дефайн

- экран 84x48
	ширина буквы 6 пикселей вместе с расстоянием между буквами

_12345678901234_
1USB 100KHz PWR1
2СССССССС      2
3СССССССС mkF  3
4RRRRRRRR      4
5RRRRRRRR KOm  5
6      12%     6
_12345678901234_



СССССССС - четыре символа включая точку, основной параметр
RRRRRRRR - дополнителный параметр
после параметра идет мелкими буквами uF, KOm и т/д
На нижней строчке точность в %


_12345678901234_
1USB 100KHz PWR1
2 100 мВ KU=7  2
3 12 мВ  KI=1  3
4 100 КОм      4
5              5
6      12%     6
_12345678901234_

Меню
 Частота
 Выбор схемы замещения

-------
- начинаем делать графический интерфейс на Qt
	- процедура калибровки
		- сначала проволим калибровку на низких частотах
		- short калибровка 
		- load калибрация на 100 ом/1 КОм/10 КОм/ 100 КОм 
			для определения правильного значения сопротивлений (сюдаже войдет и дисбаланс коэффициэнтов усиления в разных каналах)
		- open калибровка

	- графики
	
	- диалог: установить частоту и смотреть каждую секунду результат
